var e=function(){this.parse=function(e,a){var i=Date.now(),r=0,s=e.split(/\r\n|\r|\n/),l=!1,o=[],u=[];function f(e,t){u.push({message:e,line:r+1,col:t})}var p=s[r],m=p.length,c="WEBVTT",d=0,v=6;for("\ufeff"===p[0]&&(d=1,v+=1),(m<v||p.indexOf(c)!==0+d||m>v&&" "!==p[v]&&"\t"!==p[v])&&f('No valid signature. (File needs to start with "WEBVTT".)'),r++;""!=s[r]&&null!=s[r];){if(f("No blank line after the signature."),-1!=s[r].indexOf("--\x3e")){l=!0;break}r++}for(;null!=s[r];){for(var g;!l&&""==s[r];)r++;if(!l&&null==s[r])break;g={id:"",startTime:0,endTime:0,pauseOnExit:!1,direction:"horizontal",snapToLines:!0,linePosition:"auto",textPosition:50,size:100,alignment:"middle",text:"",tree:null};var h=!0;if(-1==s[r].indexOf("--\x3e")){if(g.id=s[r],/^NOTE($|[ \t])/.test(g.id)){for(r++;""!=s[r]&&null!=s[r];)-1!=s[r].indexOf("--\x3e")&&f("Cannot have timestamp in a comment."),r++;continue}if(""==s[++r]||null==s[r]){f("Cue identifier cannot be standalone.");continue}-1==s[r].indexOf("--\x3e")&&(h=!1,f("Cue identifier needs to be followed by timestamp."))}l=!1;var x=new t(s[r],f),T=0;if(o.length>0&&(T=o[o.length-1].startTime),!h||x.parse(g,T)){for(r++;""!=s[r]&&null!=s[r];){if(-1!=s[r].indexOf("--\x3e")){f("Blank line missing before cue."),l=!0;break}""!=g.text&&(g.text+="\n"),g.text+=s[r],r++}var b=new n(g.text,f,a);g.tree=b.parse(g.startTime,g.endTime),o.push(g)}else for(g=null,r++;""!=s[r]&&null!=s[r];){if(-1!=s[r].indexOf("--\x3e")){l=!0;break}r++}}return o.sort(function(e,t){return e.startTime<t.startTime?-1:e.startTime>t.startTime?1:e.endTime>t.endTime?-1:e.endTime<t.endTime?1:0}),{cues:o,errors:u,time:Date.now()-i}}},t=function(e,t){var n=/[\u0020\t\f]/,a=/[^\u0020\t\f]/,i=(e=e,0),r=function(e){t(e,i+1)};function s(t){for(;null!=e[i]&&t.test(e[i]);)i++}function l(t){for(var n="";null!=e[i]&&t.test(e[i]);)n+=e[i],i++;return n}function o(){var t,n,a,s,o="minutes";if(null!=e[i])if(/\d/.test(e[i]))if(((t=l(/\d/)).length>2||parseInt(t,10)>59)&&(o="hours"),":"==e[i])if(i++,2==(n=l(/\d/)).length){if("hours"==o||":"==e[i]){if(":"!=e[i])return void r("No seconds found or minutes is greater than 59.");if(i++,2!=(a=l(/\d/)).length)return void r("Must be exactly two digits.")}else a=n,n=t,t="0";if("."==e[i])if(i++,3==(s=l(/\d/)).length)if(parseInt(n,10)>59)r("You cannot have more than 59 minutes.");else{if(!(parseInt(a,10)>59))return 60*parseInt(t,10)*60+60*parseInt(n,10)+parseInt(a,10)+parseInt(s,10)/1e3;r("You cannot have more than 59 seconds.")}else r("Milliseconds must be given in three digits.");else r('No decimal separator (".") found.')}else r("Must be exactly two digits.");else r("No time unit separator found.");else r("Timestamp must start with a character in the range 0-9.");else r("No timestamp found.")}this.parse=function(t,l){if(s(n),t.startTime=o(),null!=t.startTime){if(t.startTime<l&&r("Start timestamp is not greater than or equal to start timestamp of previous cue."),a.test(e[i])&&r("Timestamp not separated from '--\x3e' by whitespace."),s(n),"-"!=e[i])return void r("No valid timestamp separator found.");if(i++,"-"!=e[i])return void r("No valid timestamp separator found.");if(i++,">"!=e[i])return void r("No valid timestamp separator found.");if(i++,a.test(e[i])&&r("'--\x3e' not separated from timestamp by whitespace."),s(n),t.endTime=o(),null!=t.endTime)return t.endTime<=t.startTime&&r("End timestamp is not greater than start timestamp."),a.test(e[i]),s(n),function(e,t){for(var a=e.split(n),i=[],s=0;s<a.length;s++)if(""!=a[s]){var l=a[s].indexOf(":"),o=a[s].slice(0,l);if(value=a[s].slice(l+1),-1!=i.indexOf(o)&&r("Duplicate setting."),i.push(o),""==value)return void r("No value for setting defined.");if("vertical"==o){if("rl"!=value&&"lr"!=value){r("Writing direction can only be set to 'rl' or 'rl'.");continue}t.direction=value}else if("line"==o){if(!/\d/.test(value)){r("Line position takes a number or percentage.");continue}if(-1!=value.indexOf("-",1)){r("Line position can only have '-' at the start.");continue}if(-1!=value.indexOf("%")&&value.indexOf("%")!=value.length-1){r("Line position can only have '%' at the end.");continue}if("-"==value[0]&&"%"==value[value.length-1]){r("Line position cannot be a negative percentage.");continue}if("%"==value[value.length-1]){if(parseInt(value,10)>100){r("Line position cannot be >100%.");continue}t.snapToLines=!1}t.linePosition=parseInt(value,10)}else if("position"==o){if("%"!=value[value.length-1]){r("Text position must be a percentage.");continue}if(parseInt(value,10)>100){r("Size cannot be >100%.");continue}t.textPosition=parseInt(value,10)}else if("size"==o){if("%"!=value[value.length-1]){r("Size must be a percentage.");continue}if(parseInt(value,10)>100){r("Size cannot be >100%.");continue}t.size=parseInt(value,10)}else if("align"==o){var u=["start","middle","end","left","right"];if(-1==u.indexOf(value)){r("Alignment can only be set to one of "+u.join(", ")+".");continue}t.alignment=value}else r("Invalid setting.")}}(e.substring(i),t),!0}},this.parseTimestamp=function(){var t=o();if(null==e[i])return t;r("Timestamp must not have trailing characters.")}},n=function(e,n,a){var i=0,r=function(e){"metadata"!=a&&n(e,i+1)};function s(){for(var t="data",n="",a="",s=[];null!=e[i-1]||0==i;){var l=e[i];if("data"==t)if("&"==l)a=l,t="escape";else if("<"==l&&""==n)t="tag";else{if("<"==l||null==l)return["text",n];n+=l}else if("escape"==t)if("&"==l)r("Incorrect escape."),n+=a,a=l;else if(/[abglmnsprt]/.test(l))a+=l;else if(";"==l)"&amp"==a?n+="&":"&lt"==a?n+="<":"&gt"==a?n+=">":"&lrm"==a?n+="‎":"&rlm"==a?n+="‏":"&nbsp"==a?n+=" ":(r("Incorrect escape."),n+=a+";"),t="data";else{if("<"==l||null==l)return r("Incorrect escape."),["text",n+=a];r("Incorrect escape."),n+=a+l,t="data"}else if("tag"==t)if("\t"==l||"\n"==l||"\f"==l||" "==l)t="start tag annotation";else if("."==l)t="start tag class";else if("/"==l)t="end tag";else if(/\d/.test(l))n=l,t="timestamp tag";else{if(">"==l||null==l)return">"==l&&i++,["start tag","",[],""];n=l,t="start tag"}else if("start tag"==t)if("\t"==l||"\f"==l||" "==l)t="start tag annotation";else if("\n"==l)a=l,t="start tag annotation";else if("."==l)t="start tag class";else{if(">"==l||null==l)return">"==l&&i++,["start tag",n,[],""];n+=l}else if("start tag class"==t)if("\t"==l||"\f"==l||" "==l)s.push(a),a="",t="start tag annotation";else if("\n"==l)s.push(a),a=l,t="start tag annotation";else if("."==l)s.push(a),a="";else{if(">"==l||null==l)return">"==l&&i++,s.push(a),["start tag",n,s,""];a+=l}else if("start tag annotation"==t){if(">"==l||null==l)return">"==l&&i++,["start tag",n,s,a=a.split(/[\u0020\t\f\r\n]+/).filter(function(e){if(e)return!0}).join(" ")];a+=l}else if("end tag"==t){if(">"==l||null==l)return">"==l&&i++,["end tag",n];n+=l}else if("timestamp tag"==t){if(">"==l||null==l)return">"==l&&i++,["timestamp",n];n+=l}else r("Never happens.");i++}}this.parse=function(n,l){var o={children:[]},u=o,f=[];function p(e){u.children.push({type:"object",name:e[1],classes:e[2],children:[],parent:u}),u=u.children[u.children.length-1]}function m(e){for(var t=u;t;){if(t.name==e)return!0;t=t.parent}}for(;null!=e[i];){var c=s();if("text"==c[0])u.children.push({type:"text",value:c[1],parent:u});else if("start tag"==c[0]){"chapters"==a&&r("Start tags not allowed in chapter title text.");var d=c[1];"v"!=d&&"lang"!=d&&""!=c[3]&&r("Only <v> and <lang> can have an annotation."),"c"==d||"i"==d||"b"==d||"u"==d||"ruby"==d||"rt"==d&&"ruby"==u.name?p(c):"v"==d?(m("v")&&r("<v> cannot be nested inside itself."),p(c),u.value=c[3],c[3]||r("<v> requires an annotation.")):"lang"==d?(p(c),u.value=c[3]):r("Incorrect start tag.")}else if("end tag"==c[0])"chapters"==a&&r("End tags not allowed in chapter title text."),c[1]==u.name?u=u.parent:"ruby"==c[1]&&"rt"==u.name?u=u.parent.parent:r("Incorrect end tag.");else if("timestamp"==c[0]){"chapters"==a&&r("Timestamp not allowed in chapter title text.");var v=new t(c[1],r).parseTimestamp();null!=v&&((v<=n||v>=l)&&r("Timestamp must be between start timestamp and end timestamp."),f.length>0&&f[f.length-1]>=v&&r("Timestamp must be greater than any previous timestamp."),u.children.push({type:"timestamp",value:v,parent:u}),f.push(v))}}for(;u.parent;)"v"!=u.name&&r("Required end tag missing."),u=u.parent;return o}};export{e as default};
